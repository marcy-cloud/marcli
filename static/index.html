<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cutiepie TTY</title>
    <link rel="stylesheet" href="/static/xterm.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/htmx.min.js"></script>
    <script src="/static/xterm.js"></script>
    <script>
        // Define terminal function before Alpine loads
        function terminal() {
            const data = {
                term: null,
                socket: null,
                init() {
                    console.log('Terminal init called');
                    // Initialize xterm.js terminal
                    this.term = new Terminal({
                        cursorBlink: true,
                        fontSize: 14,
                        fontFamily: 'Consolas, "Courier New", monospace'
                    });

                    // Open terminal in the container
                    const termElement = document.getElementById('terminal');
                    if (!termElement) {
                        console.error('Terminal element not found');
                        return;
                    }
                    this.term.open(termElement);
                    console.log('Terminal opened');

                    // Connect to WebSocket
                    this.connect();

                    // Handle window resize
                    window.addEventListener('resize', () => {
                        this.fitTerminal();
                    });

                    // Initial fit
                    this.fitTerminal();
                },
                connect() {
                    // Determine WebSocket URL
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;

                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        console.log('WebSocket connected');
                        this.fitTerminal();
                    };

                    this.socket.onmessage = (event) => {
                        // Write data to terminal
                        if (this.term) {
                            this.term.write(event.data);
                        }
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };

                    this.socket.onclose = () => {
                        console.log('WebSocket closed');
                        // Optionally reconnect after a delay
                        setTimeout(() => {
                            if (this.term) {
                                this.connect();
                            }
                        }, 1000);
                    };

                    // Send terminal input to WebSocket
                    if (this.term) {
                        this.term.onData((data) => {
                            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                                this.socket.send(data);
                            }
                        });

                        // Handle terminal resize - resize PTY when terminal is resized
                        this.term.onResize((size) => {
                            // Note: We can't easily send resize messages through the current
                            // WebSocket protocol without changing it. For now, the PTY will
                            // use the initial size. This can be improved later with a proper
                            // protocol for resize messages.
                        });
                    }
                },
                fitTerminal() {
                    if (this.term) {
                        // Fit terminal to container
                        const container = document.getElementById('terminal');
                        const cols = Math.max(80, Math.floor(container.clientWidth / 8.4)); // Approximate character width
                        const rows = Math.max(24, Math.floor(container.clientHeight / 17)); // Approximate line height
                        this.term.resize(cols, rows);
                    }
                }
            };
            return data;
        }
    </script>
</head>
<body>
    <div x-data="terminal()" class="container">
        <div id="terminal" class="terminal-container"></div>
    </div>
    <script src="/static/alpine.js"></script>
    <script>
        // Wait for Alpine to initialize, then call init
        (function() {
            function initializeTerminal() {
                const container = document.querySelector('[x-data]');
                if (container && container.__x && container.__x.$data) {
                    const data = container.__x.$data;
                    if (typeof data.init === 'function' && !data.term) {
                        console.log('Auto-initializing terminal...');
                        data.init();
                        return true;
                    }
                }
                return false;
            }
            
            // Try immediately if Alpine is already ready
            if (typeof Alpine !== 'undefined' && document.readyState === 'complete') {
                setTimeout(initializeTerminal, 100);
            }
            
            // Also try on DOMContentLoaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(initializeTerminal, 200);
                });
            }
            
            // Poll as fallback
            let attempts = 0;
            const maxAttempts = 30;
            const tryInit = setInterval(() => {
                attempts++;
                if (initializeTerminal() || attempts >= maxAttempts) {
                    clearInterval(tryInit);
                }
            }, 150);
        })();
    </script>
</body>
</html>

